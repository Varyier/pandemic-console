<script>
  // all storable data
  var State = {
    Towns : 
    [
    // Blue - 'B'
      {name:'Atlanta',        color:'B', ways:[1,2,3], disB:0,disK:0,disR:0, lab:true}, // 0
      {name:'Chicago',        color:'B', ways:[0,3,5], disB:0,disK:0,disR:0, lab:false}, // 1
      {name:'London',         color:'B', ways:[0,8,9], disB:0,disK:0,disR:0, lab:false}, // 2
      {name:'St. Petersburg', color:'B', ways:[0,1], disB:0,disK:0,disR:0, lab:false}, // 3

      // Black - 'K'
      {name:'Algeria',  color:'K', ways:[5,6,8], disB:0,disK:0,disR:0, lab:false}, // 4
      {name:'Moscow',   color:'K', ways:[1,4,8], disB:0,disK:0,disR:0, lab:false}, // 5
      {name:'Istambul', color:'K', ways:[4,7], disB:0,disK:0,disR:0, lab:false}, // 6
      {name:'Chennai',  color:'K', ways:[6,9,11], disB:0,disK:0,disR:0, lab:false}, // 7

      // Red - 'R'
      {name:'Seoul',   color:'R', ways:[2,4,5,9], disB:0,disK:0,disR:0, lab:false}, // 8
      {name:'Osaka',   color:'R', ways:[2,7,8,11], disB:0,disK:0,disR:0, lab:false}, // 9
      {name:'Sydney',  color:'R', ways:[11], disB:0,disK:0,disR:0, lab:false}, // 10
      {name:'Jakarta', color:'R', ways:[7,9,10], disB:0,disK:0,disR:0, lab:false} // 11
    ],
    
    Classes :
    [
      {name:'Researcher'},
      {name:'Medic'},
      {name:'Engeneer'}
    ],
    
    // define two players
    Players :
    [
      {name:'Player1', class:0, hand:[], acts:3, pos:0},
      {name:'Player2', class:1, hand:[], acts:3, pos:0}
    ],
    
    infect_deck : [0,1,2,3,4,5,6,7,8,9,10,11],
    infect_drop : [],
    
    // -1 - teleport
    // -2 - free lab
    // -3 - silent night
    // -13 - !INFECT
    help_deck : [0,1,2,3,4,5,6,7,8,9,10,11,-1,-2,-3,-13,-13,-13],
    help_drop : [],
    
    is_silent_night:false,
    dis_marker:2, // number of cards from infect deck, to use
    propagation_counter:0, // 4 - lose
    cur_turn:0,
    remedyB:false,
    remedyK:false,
    remedyR:false
  };
  alert(State.Towns[11].ways);

  // COMMANDS:
  // /help - displays help
  // /start - start new game
  // /hands - check all cards in players' hands
  // /where - check all players' position
  // /ways - show all road ways from the current position of the current player
  // /ways 'NAME' - show all road ways from a specified town
  // /clean - clean one (OR all, if can) disease element from the current position (if exist any)
  // /aleft - show available actions
  // /info - detailed info about the game state
  
  // /lab - builds a lab in the current town, spends card
  // /lab -E - (Engeneer Only) builds a lab in the current town, doesn't spend card
  
  // /warp 'NAME' - teleports current player to the specified town 'NAME', spends card 'NAME'
  // /warp -E 'NAME' 'SNAME' - (Engeneer Only) teleports current player to the specified town 'NAME', spends card 'SNAME' (one time per turn)
  
  // /give 'NAME' - gives the card 'NAME' to the other player, must be in that town both
  // /take 'NAME' - gives the card 'NAME' to the other player, must be in that town both
  // /give -R 'NAME' - (Researcher only) gives the card 'NAME' to the other player, must be in that town both
  // /take -R 'NAME' - take the card 'NAME' from the other player, must be in that town both, other player must be Researcher
  
  // /remedy 'X' 'NAME1', 'NAME2' - invent the remedy from the specified disease 'X', using two cards 'NAME1', 'NAME2'
  // /turn - end the turn
  
  var req_st = {
    command:'',
    arg1:'',
    arg2:'',
    arg3:''
  };
  
  function parse_req(req) {
    req_st.command = '';
    if(req.indexOf('/') != 0) {
      alert('Wrong request. Type \'/help\' for more info.');
    } else {
      var pos_cmd_delim = req.indexOf(' ');
      if(pos_cmd_delim == -1) {
        // no args
        req_st.command = req.slice(1, req.length);
      } else {
        // with args, probably
        req_st.command = req.slice(1, pos_cmd_delim);
      }
      
      req_st.arg1 = '';
      req_st.arg2 = '';
      req_st.arg3 = '';
      
      if(pos_cmd_delim != -1) {
        var req_cut = req.slice(pos_cmd_delim+1, req.length);
        if(req_cut.length > 0) {        
          // at least 1 arg
          var pos_arg1_delim = req_cut.indexOf(' ');
          if(pos_arg1_delim != -1) {
            req_st.arg1 = req_cut.slice(0, pos_arg1_delim);
          } else {
            req_st.arg1 = req_cut.slice(0, req_cut.length);
          }
          
          if(pos_arg1_delim != -1) {
            var req_cut2 = req_cut.slice(pos_arg1_delim+1, req_cut.length);
            if(req_cut2.length > 0) {
              var pos_arg2_delim = req_cut2.indexOf(' ');
              if(pos_arg2_delim != -1) {
                req_st.arg2 = req_cut2.slice(0, pos_arg2_delim);
              } else {
                req_st.arg2 = req_cut2.slice(0, req_cut2.length);
              }
              
              if(pos_arg2_delim != -1) {
                var req_cut3 = req_cut2.slice(pos_arg2_delim+1, req_cut2.length);
                alert('')
                if(req_cut3.length > 0) {
                  var pos_arg3_delim = req_cut3.indexOf(' ');
                  if(pos_arg2_delim != -1) {
                    req_st.arg3 = req_cut3.slice(0, pos_arg3_delim);
                  } else {
                    req_st.arg3 = req_cut3.slice(0, req_cut.length);
                  }
                  
                  //req_cut = req_cut.slice(pos_arg3_delim+1, req_cut.length);
                  
                }
              }
            }
          }
        }
      }

      // remove quotes
      if(req_st.arg1.indexOf('\'') == 0 && req_st.arg1.lastIndexOf('\'') == (req_st.arg1.length-1)) {
        req_st.arg1 = req_st.arg1.slice(1,req_st.arg1.length-1);
      }
      if(req_st.arg2.indexOf('\'') == 0 && req_st.arg2.lastIndexOf('\'') == (req_st.arg2.length-1)) {
        req_st.arg2 = req_st.arg2.slice(1,req_st.arg2.length-1);
      }
      if(req_st.arg3.indexOf('\'') == 0 && req_st.arg3.lastIndexOf('\'') == (req_st.arg3.length-1)) {
        req_st.arg3 = req_st.arg3.slice(1,req_st.arg3.length-1);
      }
    }
  }
  
  function process() {
  }
  
  function mymain() {
    i_val = document.getElementById('mainInput').value;
    if(i_val.length > 0) {
      o_val = document.getElementById('allOutput').value;
      document.getElementById('allOutput').innerHTML = o_val + '\n' + '>> ' + i_val;
      document.getElementById('mainInput').value = '';
      
      parse_req(i_val);
      
      // Debug
      alert(JSON.stringify(req_st));
      
      if(req_st.command.length > 0) {
        // load game state
        State = JSON.parse(document.getElementById('ST').value);
        // process one step (command)
        process();
        // store game state
        document.getElementById('ST').innerHTML = JSON.stringify(State);
      }
      // Debug
      //document.getElementById('allOutput').innerHTML = document.getElementById('ST').value;
    }
    // Debug
    
  }
</script>
<div class="row">
    <textarea class="form-control" rows="40" id="allOutput" readonly style="padding-left: -60px;padding-right: -60px;width: 100%;min-width: 100%;max-width: 100%; height: 400px;min-height: 400px;max-height: 400px;"></textarea>
</div>
<div class="row" onkeydown="if(event.keyCode==13) { mymain(); }">
    <div class="input-append">
        <input class="span2" id="mainInput" type="text" style="padding-left: -60px;padding-right: -60px;width: 90%;min-width: 90%;max-width: 90%;">
        <button class="btn" type="button" onclick="mymain()">Sumbit</button>
        <p id="demo"></p>
    </div>
</div>
<div class="row" hidden>
    <textarea class="form-control" rows="2" id="ST" readonly style="padding-left: -60px;padding-right: -60px;width: 100%;min-width: 100%;max-width: 100%; height: 400px;min-height: 400px;max-height: 400px;"></textarea>
</div>